#+BIBLIOGRAPHY: ../bib plain
 

* Basic structure
    
*** Case study: World Wide Web – Basic architecture

 Basic architectures \ac{WWW} very simple
 - Web servers provide "web pages"
 - Identified by a \ac{URI}
   - Resource: Target of a request; nature not specified
   - Reachable at a \ac{URL}
 - Pages formatted in \ac{HTML}
 - Web browsers request pages from servers
 - Server and browser communicate using \ac{HTTP} 
   - HTTP/1.1: RFC 7230--7235

Compare \cite[Sect.\ 2.4]{Coulouris:DistributedSystems:2011}

*** Resources and representation 

- Resource: could be anything; type not  
- Representation \cite[Sec.\ 3]{RFC7231}:

#+BEGIN_QUOTE
a "representation" is information that is intended to reflect a past,
current, or desired state of a given resource, in a format that can be
readily communicated via the protocol, and that consists of a set of
*representation metadata* and a potentially unbounded stream of
representation data
#+END_QUOTE

*** Metadata

- Header fields provide metadata about representation 
- Relevant fields:
  - Content-Type \cite{RFC2046}, e.g., ~text/html;charset=utf-8~
  - Content-Encoding, e.g., compression information like ~gzip~
  - Content-Language, natural-language information \cite{RFC5646}
  - Content-Location, absolute or relative URI  



** HTTP 

*** The request/reply protocol: HTTP

 HTTP essentially a simple protocol
 - Request primitives
   - GET: Obtain content of URL of interest
   - HEAD: Similar to GET, but only provide meta data, not actual content 
   - POST: Provide URL corresponding to a program that can accept the
     data provided in the POST message
   - PUT: Provide URL where the data provided in the PUT message should be stored 
   - ... plus various others (DELETE, OPTIONS, TRACE)
 - Reply: Return page, plus error code, status, ... 
   - REDIRECT: Important example, error code telling the browser to
     use the returned URL instead


*** Requests: Static and dynamic content

GET requests can refer to a static web page (simply delivered by the server) or to execution of a program 
 - Server might make simple modifications to a page during delivery,
   triggered e.g. by “server side include” instructions
 - Server might also compute the request page on the fly, depending on
   parameters in the request
 - Typical: “?” to signal that, key=value pairs separated by “&”
 - GET \url{http://somewhere.net/some/path/somewhere?key=somekey&param1=xyz&param2=abc}

*** Requests and state 
 - Convention: GET does not alter state of resource 
 - POST requests refer to a program execution
   - POST provides parameters to the program
   - Parameters usually depend on user input 
   - Typically, POST will alter state 
   - Output of the program is delivered back to the client and rendered as the page


** Web servers

*** Servers 

- Main job: Serve static files 
- Do not write your own webserver 

#+BEAMER: \pause

- Example full-scale servers
  - \href{https://httpd.apache.org}{Apache HTTPD}
  - \href{https://www.nginx.com}{Nginx}
  - \href{https://www.iis.net}{Internet Information Services}

#+BEAMER: \pause
- Example simple servers
  - Python's \href {https://docs.python.org/3.5/library/http.server.html#module-http.server}{http.server}
  - npm's \href{https://www.npmjs.com/package/http-server}{http-server}


*** http.server Example 

**** Basic                                                        :B_example:
     :PROPERTIES:
     :BEAMER_env: example
     :END:
\footnotesize
#+BEGIN_SRC python 
def run(server_class=HTTPServer, handler_class=BaseHTTPRequestHandler):
    server_address = ('', 8000)
    httpd = server_class(server_address, handler_class)
    httpd.serve_forever()
#+END_SRC


**** Serve files from directory                                   :B_example:
     :PROPERTIES:
     :BEAMER_env: example
     :END:

\footnotesize
#+BEGIN_SRC python 
import http.server
import socketserver

httpd = socketserver.TCPServer(("", 8000), http.server.SimpleHTTPRequestHandler)
httpd.serve_forever()
#+END_SRC     


*** http.server from command line 

Serve all that is in \ac{CWD}

**** Defaults 

#+BEGIN_SRC bash 
$ python3 -m http.server
#+END_SRC

**** With parameters 
#+BEGIN_SRC bash 
$ python3 -m http.server 8888 
#+END_SRC


*** NPM http-server 

#+BEGIN_SRC bash 
$ npm install http-server -g
$ http-server [path] [options]
#+END_SRC

Options: path, address, show directories, server gzips, proxy
unresolvable request, ... 

*** Nginx 

- Actually, more than a simple web server for static files
  - Application platform, load balancer, mircoservices, content
    caching
- With open-source and commercial versions 
- Structure: One master, multiple worker processes
  - Master: configure, control workers
    - Configuration files as input 
  - Workers: do actual work, requests distributed to workers

*** Nginx as web server                                         :B_quotation:
    :PROPERTIES:
    :BEAMER_env: quotation
    :CUSTOM_ID: nginx_config
    :END:
  
- Idea: depending on URL, server files from directories or forward to
  other "locations" 
- Order in configuration file matters 

**** Configuration                                                :B_example:
     :PROPERTIES:
     :BEAMER_env: example
     :END:

\footnotesize
#+BEGIN_SRC bash
http {
    server {
	listen 127.0.0.1:8080;
	server_name example.org www.example.org;
	location /images/ { root /data; }
	location /wrong/url { return 404; }
	location /permanently/moved/url {  return 301 http://www.example.com/moved/here;
					}
	location /users/ {  rewrite ^/users/(.*)$ /show?user=$1 break;}
	location / { proxy_pass http://www.example.com;
		   }
    } }
#+END_SRC

* Server-side programmability  

** Issue? 

*** Jobs of a typical HTTP server 

- Parse requests, schedule delivery 
- Obtain static content from disk, cache
- Compute dynamic content
  - Based on user input, local user information, ... 


#+BEAMER: \pause

- Questions: 
  - What is always the same, what needs to be adapted?
  - What happens often (hence has to be fast), what happens rarely? 


*** Often vs. rare? 
- Happens often and is usually the same
  - Parsing requests 
  - Delivering static content
  - E.g., media files, images, style information, ...
  - Happens in practically all requests 
- Happens rarely: Individual processing 



*** Division of labor 

Hence division of labor:

  - Highly optimized program for parsing request, static content
    delivery
    - A *web server* in the narrow sense of the word
  - A *web framework* to provide context for customized computation of
    dynamic responses (a *web application*) 
    - Examples: Django \url{https://www.djangoproject.com}, Tomcat \cite{ApacheTo2:online}, Ruby on Rails
      \url{http://rubyonrails.org}, Play \url{https://www.playframework.com}, ...
    - Lot's of fanboyism -- but some good comparisons
      (\href{https://en.wikipedia.org/wiki/Comparison_of_web_frameworks}{Ref1},
      \href{https://softwareengineering.stackexchange.com/questions/102090/why-isnt-java-used-for-modern-web-application-development}{Ref2})


*** Web frameworks 

Good frameworks support: 

- Mapping URLs to pieces of code (*URL routing* or *dispatching*)
  - To individual objects, URL parameters passed as parameters to
    methods 
- Templating for Web pages, form validation  
- Security/authentication/authorization 
- Database integration, caching
  - Often: \ac{ORM}
- AJAX support, Javascript integration 
- Often: Model/view/controller abstractions 


*** Side remark: Model/view/controller abstraction 




****                                                           :BMCOL:
     :PROPERTIES:
     :BEAMER_col: 0.5
     :BEAMER_opt: [c]
     :END:



- Old concept how to structure graphical user interfaces (and similar)
  \cite{Fowler:GUIArchi61:online}\cite{krasner1988description}\cite{950428}\cite{Gamma:DesignPatterns:1995:DPE:186897} 
- Components:
  - Model holds data, rules, logic
  - Views convert model into user-useful representations 
  - Controller accepts user input, sends commands to model (or
    sometimes to views) 

****                                                    :BMCOL:
     :PROPERTIES:
     :BEAMER_col: 0.5
     :BEAMER_opt: [c]
     :END:



#+CAPTION: Model/View/Controller concept
#+ATTR_LaTeX: :width 0.75\linewidth
#+NAME: fig:mvc:concept
[[./figures/mvc.pdf]]






** Simple examples 
*** A short list  

- Python world: 
  - \href{http://werkzeug.pocoo.org}{Werkzeug}
  - \href{http://flask.pocoo.org}{Flask}
    - Based on werkzeug 
  - \href{https://twistedmatrix.com/documents/17.5.0/core/howto/basics.html}{Twisted}
  - \href{http://www.tornadoweb.org/en/stable/}{Tornado}
- Javascript world (\href{see also}{https://nordicapis.com/13-node-js-frameworks-to-build-web-apis/}):
  - \href{https://expressjs.com}{Express}
  - \href{https://github.com/fastify/fastify}{Fastify}
  - \href{https://www.meteor.com/developers}{Meteor}
- Java (\href{https://zeroturnaround.com/webframeworksindex/}{see
  also}, \href{https://www.dailyrazor.com/blog/best-java-web-frameworks/}{comparison}) 
  - \href{https://spring.io}{Spring} 
  - \href{https://www.playframework.com}{Play}

*** Werkzeug 

#+BEGIN_SRC python 
from werkzeug.wrappers import Request, Response

@Request.application
def application(request):
    return Response('Hello World!')

if __name__ == '__main__':
    from werkzeug.serving import run_simple
    run_simple('localhost', 4000, application)
#+END_SRC


*** Flask 

****                                                                :B_quote:
     :PROPERTIES:
     :BEAMER_env: quote
     :END:

Flask is a microframework for Python based on Werkzeug, Jinja 2 and good intentions. And before you ask: It's BSD licensed!


**** Code 
\footnotesize 
#+BEGIN_SRC python 
from flask import Flask
app = Flask(__name__)

@app.route("/")
def hello():
    return "Hello World!"
#+END_SRC

**** Setup
\footnotesize 

#+BEGIN_SRC bash
$ pip install Flask
$ FLASK_APP=hello.py flask run
 * Running on http://localhost:5000/
#+END_SRC

*** Tornado 

- Special feature: Not based on WSGI (see below) 

**** From web site marketing: 
****                                         :B_quote:
     :PROPERTIES:
     :BEAMER_env: quote
     :END:

Tornado is a Python web framework and asynchronous networking library, originally developed at FriendFeed. By using non-blocking network I/O, Tornado can scale to tens of thousands of open connections, making it ideal for long polling, WebSockets, and other applications that require a long-lived connection to each user.


*** Tornado Hello world                                           :B_example:
     :PROPERTIES:
     :BEAMER_env: example
     :END:

\footnotesize 
#+BEGIN_SRC python
import tornado.ioloop
import tornado.web

class MainHandler(tornado.web.RequestHandler):
    def get(self):
        self.write("Hello, world")

def make_app():
    return tornado.web.Application([
        (r"/", MainHandler),
    ])

if __name__ == "__main__":
    app = make_app()
    app.listen(8888)
    tornado.ioloop.IOLoop.current().start()
#+END_SRC




*** Fastify 

#+BEGIN_SRC javascript 
// Require the framework and instantiate it
const fastify = require('fastify')()

// Declare a route
fastify.get('/', function (request, reply) {
  reply.send({ hello: 'world' })
})

// Run the server!
fastify.listen(3000, '127.0.0.1', function (err) 
{
  if (err) throw err
  console.log(`server listening on ${fastify.server.address().port}`)
})
#+END_SRC

** Detailed  framework example: Django 

*** Web frameworks – Example: Django (python) 


Idea: Model/view/controller approach, tightly integrated with an SQL database 

- Write model description (corresponds to SQL tables) as Python
  classes
- Write views to execute when user calls a URL 
- Map URLs to views via small configuration files, 
- Views are methods of Python objects with predefined signatures,
  matching HTTP messages 
- Templates render HTML as result
  - With access to Python data structures

*** Describing model/data base 




- Model: SQL data base tables 
- \ac{ORM} abstraction layer to hide SQL access behind Python classes
  and objects
- Examples follow
  \href{https://docs.djangoproject.com/en/2.0/topics/db/models/}{Django
  tutorial, v2}

#+BEGIN_SRC python 
from django.db import models

class Person(models.Model):
    first_name = models.CharField(max_length=30)
    last_name = models.CharField(max_length=30)
#+END_SRC

*** References between models 

#+BEGIN_SRC python 
from django.db import models

class Musician(models.Model):
    first_name = models.CharField(max_length=50)
    last_name = models.CharField(max_length=50)
    instrument = models.CharField(max_length=100)

class Album(models.Model):
    artist = models.ForeignKey(Musician, on_delete=models.CASCADE)
    name = models.CharField(max_length=100)
    release_date = models.DateField()
    num_stars = models.IntegerField()
#+END_SRC

*** Fields 

- Plenty of field types, e.g., BigInteger, Boolean, Date, DateTime,
  Duration, Email, file, Float, Image, Slug, Text, Time, URL, ... 
- With plenty of options: null, blank, choices, primary_key, unique,
  ... 
- \href{https://docs.djangoproject.com/en/2.0/ref/models/fields/}{Django field types}

*** SQL storage 

- Tables are storage in selectable SQL engine
- Transparent; details hidden by ORM
- Direct access possible if necessary
- Actual database
  - Great for development: \href{https://www.sqlite.org/index.html}{sqlite3}
  - For deployment: \href{https://www.mysql.com}{mysql}, \href{https://www.postgresql.org}{Postgresql} popular options
  - Configured in settings file: type, IP, port, account, password 

*** URL dispatching  

- Developer specifies pairs of
  - regular expression for URLs to be matched against
  - *class* to be called as when URL is matched 

*** Example URL dispatching  

See \href{https://docs.djangoproject.com/en/2.0/topics/http/urls/}{URLconf.py}

\footnotesize 
#+BEGIN_SRC python
from django.urls import path
from . import views

urlpatterns = [
    path('articles/2003/', views.special_case_2003.as_view()),
    path('articles/<int:year>/', views.year_archive.as_view()),
    path('articles/<int:year>/<int:month>/', views.month_archive.as_view()),
    path('articles/<int:year>/<int:month>/<slug:slug>/', views.article_detail.as_view()),
]
#+END_SRC

*** Views 

- Views are Python classes, with predefined methods
  - in particular,  ~get()~ and ~post()~ invoked for corresponding
    HTTP messages)
- Subclassed from default classes with typical combinations of
  functionality
  - Render a template (~TemplateView~)
  - Deal with an input form (~FormView~)
  - ~ListView~, ~DetailView~, ... 
  - Heavily relies on mixins to add functionality 
- New view object instantiated per call
  - Use class attributes!
  - State in database, plus cookies, plus middleware 
- Parameters in URL \ac{RE} mapped to method parameters 

*** Views: Example
     :PROPERTIES:
     :BEAMER_env: example
     :END:

In ~views.py~: 

#+BEGIN_SRC python 
from django.http import HttpResponse
from django.views import TemplateView

class article_detail(TemplateView):
    template_name = "article_detail.html"
    def get(self, year, month, slug, request, **kwargs):
        context = super().get_context_data(**kwargs)
        context['year'] = 1984
        return context        
#+END_SRC

*** Template engine 

**** Problem 

- Browser expects an HTML document as result of a request
- Framework deals with data structure, Python objects
- Generating HTML pages from data structures possible, but cumbersome 

**** Solution: Engine 

- Template engines turn data structures into HTML documents by filling
  in templates 

*** Example engine: Jinja2 

- See \href{http://jinja.pocoo.org/docs/2.10/}{Jinja2 website}
- Expands HTML template using data structures (here: Python) as input
  to substitute patterns 
- With loops, if, ... 
- When invoked from a Django ~TemplateView~, has access to the view's
  returned  context data 

*** Jinja Template example

- Context attributes accessible in evaluation context
  - Use ~{{ ... }}~ for variable substition
  - Use ~{% ... %}~ to call functions from template 

#+BEGIN_SRC html
<title>{% block title %}{% endblock %}</title>
<ul>
{% for user in users %}
  <li><a href="{{ user.url }}">{{ user.username }}</a></li>
{% endfor %}
</ul>
#+END_SRC

** Running a Web framework 
- Templates to render HTML as result, allowing access to Python data
  structures 
  - Can integrate various templating engines (in particular, Jinja2
    \cite{Jinja2:online}) 

*** Running Web applications in Web servers
- Remaining question: How to run Web application code (written against
  a given framework) inside a Web server?  
- Or: how to tell the Web server which code to invoke for a given HTTP
  get, post, \ldots  request?  
  - Note: Web frameworks often include ``toy'' web servers; good for
    debugging, but not scalable, secure, performing enough \ldots for
    production use
- Easy part: have Web server deal with static material
  - Put it in separate directory; configure Web server (cp. e.g. Slide [[#nginx_config]])
  - Possibly generated by framework, possibly truly static (e.g., CSS
    files) 
- Necessary: interface between server and framework for dynamic
  content 
 

*** Running Web applications in Web servers: Interface 

- Example: Web Server Gateway Interface (WSGI) for Python
  \cite{eby10:_python_web_server_gatew_inter} 
  - Actually: a calling convention between web servers and web
    frameworks 
  - Similar for other languages/frameworks, e.g., Servlet API for
    Java  
- Devil is in the details, though – lot’s of configuration ... 

*** WSGI approach 

- Upon request, server calls framework (at defined function) with
    environment and callback  
- Framework executes request, computes result (i.e., a HTML
    document) and calls the server’s callback function  
- Often realized by a middleware implementing both server and
  framework side (which can enrich functionality of
  this interface, e.g., by loadbalancing)
- Multiple framework implementations exist
  - Example \href{https://uwsgi-docs.readthedocs.io/en/latest/}{uWSGI}
    - Generalizes to other languages as well
    - Include management for many instances (so-called Emperor) 

*** Example setup: django, nginx, uwsgi  

Ingredients 

- django as web framework 
  - To run actual application code 
  - To award meaning to nice-looking URLs
- nginx as web server 
  - To filter out URLs that need to be passed on to the web framework 
  - To serve static content (not dynamically computed per request via
    the web framework): fixed HTML, CSS, images, \ldots 
- uwsgi to couple the web server to django 
- postgresql as database 


*** Example setup: django, nginx, uwsgi  

#+CAPTION: Typical web application pipeline
#+ATTR_LaTeX: :width 0.95\linewidth
#+NAME: fig:uwsgipipeline
[[./figures/uwsgi.pdf]]



*** Example configurations 

- Follows example \href{http://uwsgi-docs.readthedocs.io/en/latest/tutorials/Django_and_nginx.html}{here} 
- Hint: use virtualenv for less heartache 


**** django 

- Not much to do, django typically creates a wsgi file ~mysite.wsgi~
  which can be given to uWSGI 


**** uWSGI 

#+BEGIN_SRC bash
$ uwsgi --socket 8001 --module mysite.wsgi --chmod-socket=664
#+END_SRC

Will run django framework as module 

*** Example configurations 
**** nginx 


\footnotesize
#+BEGIN_SRC bash 
upstream django { server 127.0.0.1:8001; }

server {
    listen      8000;
    server_name example.com; 
    charset     utf-8;

    location /media  {
        alias /path/to/your/mysite/media;  
    }
    location /static {
        alias /path/to/your/mysite/static; 
    }
    location / {
        uwsgi_pass  django;
        include     /path/to/your/mysite/uwsgi_params; 
    }}
#+END_SRC

** Outlook 


*** How to pick the right stack 

- Plenty of options exist
- But each project is different 
- Do not
  - Use competitor experience
  - Use prior experience (only with grain of salt) 
  - Beware of team/personnel/private preferences
    - But factor in lead time if training required
  - Obey checklists on the web, marketing hype 




* Client-side programmability                                      :noexport:

*** Issue: latency for complex interactions 

*** Applications in the WWW – State & cookies 
 By design, HTTP is stateless, so are Web servers
 - How to build applications in such an environment? 
 - 
 - How to still provide some statefulness in WWW context? 
 - How to eat your cake and have it? Cookies! 
 - 
 - Cookie: Text string, sent by server to client, stored by browser 
 - Main standards: RFC 2109, RFC 2965 
 - Returned by browser to server with any request to a server matching the domain stated in the cookie (and where the path matches as well)
 - Useful to identify users, store application state AT CLIENT, … 
 - Can encode many different types of information 
 - Alternatives to store state: complex URLs, dynamically updated and returned 
 - 
 - Simple, sometimes useful, yet problematic 
 - Malicious cookie theft, inconsistencies between server/browser, … 
*** Applications in the WWW – AJAX 
 Interactive web applications easy in principle
 - Changes result in POST messages, new Web page is returned
 - Problem: Latency, bandwidth to transmit entire new page (after each user interaction!) limits “interactive feel” 
 - Approach: Asynchronous JavaScript and XML – AJAX 
 By DanielSHaischt, via Wikimedia Commons - https://commons.wikimedia.org/wiki/File%3AAjax-vergleich.svg, CC BY-SA 3.0, https://commons.wikimedia.org/w/index.php?curid=29724785
*** AJAX: Basic ideas 
 41
*** AJAX example
 42
*** AJAX: XMLHttpRequest 
 43
*** AJAX: Relevant libraries 
 44
*** DOM manipulation 

*** General idea: Event-based programming 

- Asynchronous requests! 
- Event loops, call backs 
- Promises, futures, ? 



*** Example Anuglar.JS 
*** Model/view controller abstraction 
*** Other example:  WebSocket 
  45


- not sure this is so important ? 



*** TODO Suitable server: Torndao 
- http://www.tornadoweb.org/en/stable/ 
- Or introduce in the server section? 


* Interfacing clients and servers: REST                            :noexport:

*** A variation on the web services theme: REST
 Web services can use complex interfaces 
 - Specified with SOAP, WSDL
 - Allow complex interaction relationships between users and providers of such services
 - 
 - Beauty in simplicity?
 - Use a very restricted interface set: create, read, update, delete (CRUD)
 - Sounds like GET, PUT, DELETE, POST ? 
 - Concentrate on the manipulation of data through such a simple interface
 - When accessing a data resource, the entire resource is provided (i.e., web page is downloaded) and can then be locally manipulated instead of complex interface operations 
 - 
 -  ! Realized in Representational state transfer (REST)
 - Fielding, Architectural Styles and the Design of Network-based Software Architectures, 2000
*** REST architecture: Constraints 
 114
*** REST: Uniform interface 
 115
*** Representations contain information to discover resources??
 116
*** REST as specialisation of WebServices 
 117
*** RESTful: Collections vs. HTTP methods 
 https://en.wikipedia.org/wiki/Representational_state_transfer, retrieved 2016-11-14
 nullipotent
 idem-
 - potent
 idem-
 - potent
 server 
 - chooses URI
 client
 - chooses URI
*** RESTful: URL patterns 
 119
*** RESTful: URL patterns practically 
 120

#+BEGIN_SRC  html
 <html>
<body>
  <form action="form_handler.php" method=”POST">
    User Name: <input name="user" type="text" />
   <input type="submit"value="Submit" />
  </form>
 </body>
 </html>
#+END_SRC

 No DELETE, PUT, 
 - ... supported!
*** RESTful: Interface descriptions? 
 121
*** Swagger examples 

*** Swagger examples 

*** Examples
 Several popular sites provide Web services 
 - Yahoo, google, ebay, Amazon, … 
 - Example: Access to Google’s Map api 
 - You’ll need: 
 - a programming language that can curl a URL 
 - Interpret the resulting JSON
 - 
 import requests
 - import json
 - 
 - r = requests.get(“https://maps.googleapis.com/maps/api/
 - geocode/json?address=Warbugrstr. 100, Paderborn")
 - 
 - print json.dumps(r.json(), indent=4)


* Current development: HTTP2, SPDY                                 :noexport:

*** Perceived HTTP 1.1 shortcomings 
 60
*** Current developments: HTTP 2.0 / SPDY © Google
 61
*** SPDY design ideas
 62
 http://www.chromium.org/spdy/spdy-whitepaper
*** HTTP 2.0 (https://datatracker.ietf.org/doc/draft-ietf-httpbis-http2/) 
 63
*** HTTP 2.0 
 64
*** SPDY / HTTP 2.0 availability 
 http://caniuse.com/spdy
*** SPDY / HTTP 2.0 availability 
 http://caniuse.com/#feat=http2


*** Example: REST, Angular, Django 



* An architecture style: microservices                             :noexport:

*** Microservices: Architecture pattern 
 126
*** Microservices: Architecture pattern – So? 
 127


*** TODO Case study: Reactive Systems  

- Check, does this really belong here? 

*** Reactive Systems – “Manifesto”
 129
*** Typesafe reactive platform 
 130
 Programs, in Java or Scala, 
 - running on JVM 
 Data engine 
 Message-driven 
 - middleware, based on actors
 Web framework 
*** Typesafe: Actors programming model 
 131
*** Typesafe: ConductR – Cluster runtime 
 132


*** Example: Snort as microservice or NFV 

- Not sure there is time for that? 
